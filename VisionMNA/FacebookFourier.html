<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mejoramiento de Imágenes con Fourier - Visión Computacional</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
            background: linear-gradient(to bottom, #5b7ab5 0%, #3b5998 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: #3b5998;
            color: white;
            padding: 20px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 24px;
            margin-bottom: 10px;
        }
        
        .content {
            padding: 20px;
        }
        
        .upload-section {
            background: #f6f7f9;
            border: 2px dashed #cbd0d8;
            border-radius: 8px;
            padding: 30px;
            text-align: center;
            margin-bottom: 20px;
        }
        
        .upload-section input[type="file"] {
            display: none;
        }
        
        .upload-btn {
            background: #4267b2;
            color: white;
            padding: 12px 30px;
            border: none;
            border-radius: 4px;
            font-size: 16px;
            cursor: pointer;
            transition: background 0.3s;
            display: inline-block;
        }
        
        .upload-btn:hover {
            background: #365899;
        }
        
        .process-btn {
            background: #42b72a;
            color: white;
            padding: 12px 30px;
            border: none;
            border-radius: 4px;
            font-size: 16px;
            cursor: pointer;
            transition: background 0.3s;
            margin-top: 15px;
        }
        
        .process-btn:hover {
            background: #36a420;
        }
        
        .process-btn:disabled {
            background: #cccccc;
            cursor: not-allowed;
        }
        
        .original-section {
            margin: 20px 0;
            text-align: center;
        }
        
        .original-section h2 {
            color: #333;
            margin-bottom: 15px;
            font-size: 20px;
        }
        
        canvas {
            border: 1px solid #ddd;
            border-radius: 4px;
            max-width: 100%;
            height: auto;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .results-section {
            margin-top: 30px;
        }
        
        .results-section h2 {
            color: #333;
            margin-bottom: 20px;
            font-size: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #3b5998;
        }
        
        .filter-category {
            margin-bottom: 30px;
        }
        
        .filter-category h3 {
            color: #4267b2;
            margin-bottom: 15px;
            font-size: 18px;
        }
        
        .filters-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 25px;
        }
        
        .filter-result {
            background: #f6f7f9;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }
        
        .filter-result h4 {
            color: #555;
            margin-bottom: 10px;
            font-size: 16px;
            font-weight: bold;
        }
        
        .filter-result canvas {
            max-width: 100%;
            height: auto;
        }
        
        .filter-description {
            margin-top: 10px;
            padding: 10px;
            background: white;
            border-radius: 5px;
            font-size: 13px;
            color: #666;
            text-align: left;
            line-height: 1.5;
        }
        
        .post-button {
            background: #42b72a;
            color: white;
            padding: 15px 40px;
            border: none;
            border-radius: 6px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            margin: 30px auto;
            display: block;
            transition: background 0.3s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        
        .post-button:hover {
            background: #36a420;
            transform: translateY(-1px);
            box-shadow: 0 3px 6px rgba(0,0,0,0.3);
        }
        
        .post-button:disabled {
            background: #cccccc;
            cursor: not-allowed;
            transform: none;
        }
        
        .feed-section {
            margin-top: 40px;
            padding-top: 30px;
            border-top: 3px solid #3b5998;
        }
        
        .feed-section h2 {
            color: #3b5998;
            margin-bottom: 25px;
            font-size: 24px;
        }
        
        .post-item {
            background: #f6f7f9;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 25px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .post-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #ddd;
        }
        
        .post-avatar {
            width: 40px;
            height: 40px;
            background: #4267b2;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 20px;
        }
        
        .post-info {
            flex: 1;
        }
        
        .post-author {
            font-weight: bold;
            color: #3b5998;
            font-size: 15px;
        }
        
        .post-time {
            color: #90949c;
            font-size: 12px;
        }
        
        .post-content {
            margin-bottom: 15px;
        }
        
        .post-images {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }
        
        .post-images canvas {
            width: 100%;
            height: auto;
            border-radius: 4px;
            border: 1px solid #ddd;
        }
        
        .interpretation-text {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            border-left: 4px solid #4267b2;
        }
        
        .interpretation-text h4 {
            color: #4267b2;
            margin-bottom: 10px;
            font-size: 16px;
        }
        
        .interpretation-text p {
            color: #333;
            line-height: 1.6;
            margin-bottom: 10px;
            font-size: 14px;
        }
        
        .no-posts {
            text-align: center;
            padding: 40px;
            color: #666;
            font-style: italic;
        }
        
        .feedback-section {
            background: #f6f7f9;
            border-top: 1px solid #e5e5e5;
            padding: 20px;
            margin-top: 30px;
        }
        
        .feedback-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .like-button {
            background: white;
            border: 1px solid #cbd0d8;
            padding: 8px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s;
        }
        
        .like-button:hover {
            background: #e7f3ff;
            border-color: #4267b2;
        }
        
        .like-button.liked {
            background: #4267b2;
            color: white;
            border-color: #4267b2;
        }
        
        .like-icon {
            font-size: 18px;
        }
        
        .comment-box {
            background: white;
            border: 1px solid #cbd0d8;
            border-radius: 20px;
            padding: 10px 15px;
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .comment-box input {
            flex: 1;
            border: none;
            outline: none;
            font-size: 14px;
        }
        
        .comment-btn {
            background: #4267b2;
            color: white;
            border: none;
            padding: 6px 15px;
            border-radius: 15px;
            cursor: pointer;
            font-size: 13px;
        }
        
        .comment-btn:hover {
            background: #365899;
        }
        
        .comments-list {
            margin-top: 15px;
        }
        
        .comment {
            background: white;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 10px;
            border-left: 3px solid #4267b2;
        }
        
        .comment-author {
            font-weight: bold;
            color: #3b5998;
            font-size: 13px;
            margin-bottom: 5px;
        }
        
        .comment-text {
            color: #333;
            font-size: 14px;
        }
        
        .comment-time {
            color: #90949c;
            font-size: 11px;
            margin-top: 5px;
        }
        
        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }
        
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #4267b2;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .hidden {
            display: none;
        }
        
        .info-box {
            background: #e7f3ff;
            border-left: 4px solid #4267b2;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 4px;
        }
        
        .info-box p {
            color: #333;
            font-size: 14px;
            line-height: 1.6;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🖼️ Mejoramiento de Imágenes con Transformada de Fourier</h1>
            <p>Tarea de Visión Computacional - Filtros Pasa-Bajas y Pasa-Altas</p>
        </div>
        
        <div class="content">
            <div class="info-box">
                <p><strong>📚 Instrucciones:</strong> Suba una imagen para aplicar filtros de mejoramiento en el dominio de frecuencia usando la Transformada de Fourier. Se procesarán 6 filtros diferentes (3 pasa-bajas y 3 pasa-altas).</p>
            </div>
            
            <div class="upload-section">
                <h3 style="margin-bottom: 15px;">📤 Subir Imagen</h3>
                <input type="file" id="imageUpload" accept="image/*">
                <label for="imageUpload" class="upload-btn">Seleccionar Imagen</label>
                <p id="fileName" style="margin-top: 10px; color: #666;"></p>
                <button id="processBtn" class="process-btn" onclick="processImage()" disabled>🔬 Procesar con Filtros de Fourier</button>
            </div>
            
            <div id="originalSection" class="original-section hidden">
                <h2>📷 Imagen Original</h2>
                <canvas id="originalCanvas"></canvas>
            </div>
            
            <div id="loadingSection" class="loading hidden">
                <div class="spinner"></div>
                <p>Procesando imagen con filtros de Fourier...</p>
            </div>
            
            <div id="resultsSection" class="results-section hidden">
                <h2>✨ Resultados del Procesamiento</h2>
                
                <div class="filter-category">
                    <h3>🔽 Filtros Pasa-Bajas (Suavizado - Eliminan alta frecuencia/detalles)</h3>
                    <div class="filters-grid">
                        <div class="filter-result">
                            <h4>Ideal</h4>
                            <canvas id="lpIdeal"></canvas>
                            <div class="filter-description">
                                <strong>Efecto:</strong> Corte abrupto en frecuencia. Suaviza pero puede crear efecto "ringing" (anillos).
                            </div>
                        </div>
                        <div class="filter-result">
                            <h4>Butterworth (n=2)</h4>
                            <canvas id="lpButterworth"></canvas>
                            <div class="filter-description">
                                <strong>Efecto:</strong> Transición suave. Reduce ruido sin ringing excesivo. Más natural.
                            </div>
                        </div>
                        <div class="filter-result">
                            <h4>Gaussian</h4>
                            <canvas id="lpGaussian"></canvas>
                            <div class="filter-description">
                                <strong>Efecto:</strong> Transición muy suave. El más natural. Tipo "blur" clásico.
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="filter-category">
                    <h3>🔼 Filtros Pasa-Altas (Realce de bordes - Eliminan baja frecuencia)</h3>
                    <div class="filters-grid">
                        <div class="filter-result">
                            <h4>Ideal</h4>
                            <canvas id="hpIdeal"></canvas>
                            <div class="filter-description">
                                <strong>Efecto:</strong> Resalta bordes abruptamente. Puede verse "artificial".
                            </div>
                        </div>
                        <div class="filter-result">
                            <h4>Butterworth (n=2)</h4>
                            <canvas id="hpButterworth"></canvas>
                            <div class="filter-description">
                                <strong>Efecto:</strong> Realza bordes suavemente. Buen balance entre detalle y naturalidad.
                            </div>
                        </div>
                        <div class="filter-result">
                            <h4>Gaussian</h4>
                            <canvas id="hpGaussian"></canvas>
                            <div class="filter-description">
                                <strong>Efecto:</strong> Realce de bordes muy gradual. Detecta contornos sutiles.
                            </div>
                        </div>
                    </div>
                </div>
                
                <button id="postButton" class="post-button" onclick="publishToFeed()">📤 Publicar Resultado en mi Feed</button>
            </div>
            
            <div class="feedback-section">
                <h3 style="margin-bottom: 15px; color: #3b5998;">💬 Feedback (Estilo Facebook 2008)</h3>
                <div class="feedback-header">
                    <button id="likeButton" class="like-button" onclick="toggleLike()">
                        <span class="like-icon">👍</span>
                        <span id="likeText">Me gusta</span>
                        <span id="likeCount"></span>
                    </button>
                </div>
                
                <div class="comment-box">
                    <input type="text" id="commentInput" placeholder="Escribe un comentario...">
                    <button class="comment-btn" onclick="addComment()">Publicar</button>
                </div>
                
                <div class="comments-list" id="commentsList"></div>
            </div>
            
            <div class="feed-section" id="feedSection">
                <h2>📱 Mi Feed de Procesamiento de Imágenes</h2>
                <div style="background: #e7f3ff; border-left: 4px solid #4267b2; padding: 15px; margin-bottom: 20px; border-radius: 4px;">
                    <p style="margin: 0; color: #333; font-size: 14px;">
                        <strong>💾 Persistencia de Datos:</strong> Tus publicaciones se guardan automáticamente en el navegador. 
                        ¡Todos los visitantes verán los posts de ejemplo al entrar! Cuando publiques tu propio procesamiento, 
                        los ejemplos se reemplazarán con tus resultados reales.
                    </p>
                </div>
                <div id="feedContainer">
                    <div class="no-posts">
                        Aún no has publicado ningún resultado. Procesa una imagen y haz clic en "Publicar Resultado" para crear tu primera publicación.
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let likes = 0;
        let isLiked = false;
        let uploadedImage = null;
        let currentResults = {}; // Store current processing results
        let feedPosts = []; // Store all feed posts
        
        // Initialize feed with saved posts or example data
        function initializeFeed() {
            try {
                // Try to load from localStorage
                const savedPosts = localStorage.getItem('fourierFeedPosts');
                if (savedPosts) {
                    feedPosts = JSON.parse(savedPosts);
                    // Convert timestamp strings back to Date objects
                    feedPosts.forEach(post => {
                        post.timestamp = new Date(post.timestamp);
                    });
                    renderFeed();
                    return;
                }
            } catch (e) {
                console.log('LocalStorage no disponible, usando datos de ejemplo');
            }
            
            // If no saved posts, load example data
            loadExampleData();
        }
        
        function loadExampleData() {
            // Create example posts to show how the app works
            feedPosts = [
                {
                    id: Date.now() - 7200000, // 2 hours ago
                    timestamp: new Date(Date.now() - 7200000),
                    originalImage: createExampleImage('Ejemplo: Paisaje', '#4a90e2'),
                    results: {
                        lpIdeal: createExampleImage('Pasa-Bajas Ideal', '#e8f4f8'),
                        lpButterworth: createExampleImage('Pasa-Bajas Butterworth', '#d4e9f4'),
                        lpGaussian: createExampleImage('Pasa-Bajas Gaussian', '#c0ddf0'),
                        hpIdeal: createExampleImage('Pasa-Altas Ideal', '#2c3e50'),
                        hpButterworth: createExampleImage('Pasa-Altas Butterworth', '#34495e'),
                        hpGaussian: createExampleImage('Pasa-Altas Gaussian', '#505d6b')
                    },
                    interpretation: generateInterpretation(),
                    isExample: true
                },
                {
                    id: Date.now() - 3600000, // 1 hour ago
                    timestamp: new Date(Date.now() - 3600000),
                    originalImage: createExampleImage('Ejemplo: Arquitectura', '#e74c3c'),
                    results: {
                        lpIdeal: createExampleImage('LP Ideal', '#fadbd8'),
                        lpButterworth: createExampleImage('LP Butterworth', '#f5b7b1'),
                        lpGaussian: createExampleImage('LP Gaussian', '#f1948a'),
                        hpIdeal: createExampleImage('HP Ideal', '#641e16'),
                        hpButterworth: createExampleImage('HP Butterworth', '#7b241c'),
                        hpGaussian: createExampleImage('HP Gaussian', '#922b21')
                    },
                    interpretation: generateInterpretation(),
                    isExample: true
                }
            ];
            
            renderFeed();
        }
        
        function createExampleImage(text, color) {
            const canvas = document.createElement('canvas');
            canvas.width = 200;
            canvas.height = 150;
            const ctx = canvas.getContext('2d');
            
            // Gradient background
            const gradient = ctx.createLinearGradient(0, 0, 200, 150);
            gradient.addColorStop(0, color);
            gradient.addColorStop(1, adjustColor(color, -30));
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, 200, 150);
            
            // Text
            ctx.fillStyle = 'white';
            ctx.font = 'bold 16px Arial';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.shadowColor = 'rgba(0,0,0,0.5)';
            ctx.shadowBlur = 4;
            ctx.fillText(text, 100, 75);
            
            return canvas.toDataURL();
        }
        
        function adjustColor(color, amount) {
            const num = parseInt(color.replace('#', ''), 16);
            const r = Math.max(0, Math.min(255, (num >> 16) + amount));
            const g = Math.max(0, Math.min(255, ((num >> 8) & 0x00FF) + amount));
            const b = Math.max(0, Math.min(255, (num & 0x0000FF) + amount));
            return '#' + ((r << 16) | (g << 8) | b).toString(16).padStart(6, '0');
        }
        
        function saveFeedToStorage() {
            try {
                localStorage.setItem('fourierFeedPosts', JSON.stringify(feedPosts));
            } catch (e) {
                console.log('No se pudo guardar en localStorage:', e);
            }
        }
        
        // Initialize feed on page load
        window.addEventListener('DOMContentLoaded', initializeFeed);
        
        // File upload handler
        document.getElementById('imageUpload').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                document.getElementById('fileName').textContent = `📄 ${file.name}`;
                document.getElementById('processBtn').disabled = false;
                
                // Load and display original image
                const reader = new FileReader();
                reader.onload = function(event) {
                    const img = new Image();
                    img.onload = function() {
                        uploadedImage = img;
                        displayOriginalImage(img);
                    };
                    img.src = event.target.result;
                };
                reader.readAsDataURL(file);
            }
        });
        
        function displayOriginalImage(img) {
            const canvas = document.getElementById('originalCanvas');
            const ctx = canvas.getContext('2d');
            
            // Resize for display
            const maxSize = 400;
            let width = img.width;
            let height = img.height;
            
            if (width > maxSize || height > maxSize) {
                const ratio = Math.min(maxSize / width, maxSize / height);
                width = Math.floor(width * ratio);
                height = Math.floor(height * ratio);
            }
            
            canvas.width = width;
            canvas.height = height;
            ctx.drawImage(img, 0, 0, width, height);
            
            // Store original for feed
            currentResults['original'] = canvas.toDataURL();
            
            document.getElementById('originalSection').classList.remove('hidden');
        }
        
        function toggleLike() {
            isLiked = !isLiked;
            const button = document.getElementById('likeButton');
            const likeText = document.getElementById('likeText');
            const likeCount = document.getElementById('likeCount');
            
            if (isLiked) {
                likes++;
                button.classList.add('liked');
                likeText.textContent = '¡Te gusta!';
            } else {
                likes--;
                button.classList.remove('liked');
                likeText.textContent = 'Me gusta';
            }
            
            likeCount.textContent = likes > 0 ? `(${likes})` : '';
        }
        
        function addComment() {
            const input = document.getElementById('commentInput');
            const text = input.value.trim();
            
            if (text) {
                const commentsList = document.getElementById('commentsList');
                const comment = document.createElement('div');
                comment.className = 'comment';
                
                const now = new Date();
                const timeStr = now.toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' });
                
                comment.innerHTML = `
                    <div class="comment-author">Usuario Anónimo</div>
                    <div class="comment-text">${text}</div>
                    <div class="comment-time">Hace un momento · ${timeStr}</div>
                `;
                
                commentsList.insertBefore(comment, commentsList.firstChild);
                input.value = '';
            }
        }
        
        // Allow Enter key to submit comment
        document.getElementById('commentInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                addComment();
            }
        });
        
        function processImage() {
            if (!uploadedImage) {
                alert('Por favor, primero suba una imagen.');
                return;
            }
            
            document.getElementById('loadingSection').classList.remove('hidden');
            document.getElementById('resultsSection').classList.add('hidden');
            
            // Process in next tick to show loading animation
            setTimeout(() => {
                try {
                    applyFourierFilters(uploadedImage);
                    document.getElementById('loadingSection').classList.add('hidden');
                    document.getElementById('resultsSection').classList.remove('hidden');
                } catch (error) {
                    document.getElementById('loadingSection').classList.add('hidden');
                    alert('Error al procesar la imagen: ' + error.message);
                    console.error(error);
                }
            }, 100);
        }
        
        function applyFourierFilters(img) {
            // Create processing canvas
            const tempCanvas = document.createElement('canvas');
            const tempCtx = tempCanvas.getContext('2d');
            
            // Resize for processing (max 128 for better stability, can go up to 256)
            const maxProcessSize = 128;
            let width = img.width;
            let height = img.height;
            
            if (width > maxProcessSize || height > maxProcessSize) {
                const ratio = Math.min(maxProcessSize / width, maxProcessSize / height);
                width = Math.floor(width * ratio);
                height = Math.floor(height * ratio);
            }
            
            // Ensure minimum size
            width = Math.max(32, width);
            height = Math.max(32, height);
            
            tempCanvas.width = width;
            tempCanvas.height = height;
            tempCtx.drawImage(img, 0, 0, width, height);
            
            // Get image data
            const imageData = tempCtx.getImageData(0, 0, width, height);
            const data = imageData.data;
            
            // Convert to grayscale
            const grayData = new Float32Array(width * height);
            for (let i = 0; i < width * height; i++) {
                if (i * 4 + 2 < data.length) {
                    const r = data[i * 4];
                    const g = data[i * 4 + 1];
                    const b = data[i * 4 + 2];
                    grayData[i] = 0.299 * r + 0.587 * g + 0.114 * b;
                }
            }
            
            // Apply filters
            const D0 = 30; // Cutoff frequency
            const n = 2;   // Butterworth order
            
            // Low-pass filters
            applyFilter(grayData, width, height, 'ideal', true, D0, n, 'lpIdeal');
            applyFilter(grayData, width, height, 'butterworth', true, D0, n, 'lpButterworth');
            applyFilter(grayData, width, height, 'gaussian', true, D0, n, 'lpGaussian');
            
            // High-pass filters
            applyFilter(grayData, width, height, 'ideal', false, D0, n, 'hpIdeal');
            applyFilter(grayData, width, height, 'butterworth', false, D0, n, 'hpButterworth');
            applyFilter(grayData, width, height, 'gaussian', false, D0, n, 'hpGaussian');
        }
        
        function applyFilter(grayData, width, height, filterType, isLowPass, D0, n, canvasId) {
            try {
                // Ensure dimensions are power of 2 for FFT
                const newWidth = Math.pow(2, Math.ceil(Math.log2(width)));
                const newHeight = Math.pow(2, Math.ceil(Math.log2(height)));
                
                // Pad the data if necessary
                let paddedData = grayData;
                let actualWidth = width;
                let actualHeight = height;
                
                if (newWidth !== width || newHeight !== height) {
                    paddedData = new Float32Array(newWidth * newHeight);
                    paddedData.fill(0);
                    for (let y = 0; y < height; y++) {
                        for (let x = 0; x < width; x++) {
                            paddedData[y * newWidth + x] = grayData[y * width + x];
                        }
                    }
                    actualWidth = newWidth;
                    actualHeight = newHeight;
                }
                
                // Apply 2D FFT
                const fftResult = fft2d(paddedData, actualWidth, actualHeight);
                
                // Create filter
                const filter = createFrequencyFilter(actualWidth, actualHeight, filterType, isLowPass, D0, n);
                
                // Apply filter in frequency domain
                for (let i = 0; i < actualWidth * actualHeight; i++) {
                    fftResult.real[i] *= filter[i];
                    fftResult.imag[i] *= filter[i];
                }
                
                // Inverse FFT
                const result = ifft2d(fftResult, actualWidth, actualHeight);
                
                // Crop back to original size
                const croppedResult = new Float32Array(width * height);
                for (let y = 0; y < height; y++) {
                    for (let x = 0; x < width; x++) {
                        croppedResult[y * width + x] = result[y * actualWidth + x];
                    }
                }
                
                // Normalize and display
                displayResult(croppedResult, width, height, canvasId);
            } catch (error) {
                console.error(`Error in ${canvasId}:`, error);
                // Display error on canvas
                const canvas = document.getElementById(canvasId);
                canvas.width = 200;
                canvas.height = 50;
                const ctx = canvas.getContext('2d');
                ctx.fillStyle = '#f0f0f0';
                ctx.fillRect(0, 0, 200, 50);
                ctx.fillStyle = '#ff0000';
                ctx.font = '12px Arial';
                ctx.fillText('Error procesando', 10, 25);
            }
        }
        
        function createFrequencyFilter(width, height, type, isLowPass, D0, n) {
            const filter = new Float32Array(width * height);
            const centerX = width / 2;
            const centerY = height / 2;
            
            for (let y = 0; y < height; y++) {
                for (let x = 0; x < width; x++) {
                    // Shift coordinates for FFT
                    const u = x < width / 2 ? x : x - width;
                    const v = y < height / 2 ? y : y - height;
                    const D = Math.sqrt(u * u + v * v);
                    
                    let H;
                    if (type === 'ideal') {
                        H = D <= D0 ? 1 : 0;
                    } else if (type === 'butterworth') {
                        H = 1 / (1 + Math.pow(D / D0, 2 * n));
                    } else if (type === 'gaussian') {
                        H = Math.exp(-(D * D) / (2 * D0 * D0));
                    }
                    
                    // Invert for high-pass
                    if (!isLowPass) {
                        H = 1 - H;
                    }
                    
                    filter[y * width + x] = H;
                }
            }
            
            return filter;
        }
        
        function fft2d(data, width, height) {
            const real = new Float32Array(data);
            const imag = new Float32Array(width * height);
            
            // FFT on rows
            for (let y = 0; y < height; y++) {
                const rowReal = new Float32Array(width);
                const rowImag = new Float32Array(width);
                
                for (let x = 0; x < width; x++) {
                    const idx = y * width + x;
                    if (idx < real.length) {
                        rowReal[x] = real[idx];
                        rowImag[x] = imag[idx];
                    }
                }
                
                const fftRow = fft(rowReal, rowImag);
                
                for (let x = 0; x < width; x++) {
                    const idx = y * width + x;
                    if (idx < real.length && x < fftRow.real.length) {
                        real[idx] = fftRow.real[x];
                        imag[idx] = fftRow.imag[x];
                    }
                }
            }
            
            // FFT on columns
            for (let x = 0; x < width; x++) {
                const colReal = new Float32Array(height);
                const colImag = new Float32Array(height);
                
                for (let y = 0; y < height; y++) {
                    const idx = y * width + x;
                    if (idx < real.length) {
                        colReal[y] = real[idx];
                        colImag[y] = imag[idx];
                    }
                }
                
                const fftCol = fft(colReal, colImag);
                
                for (let y = 0; y < height; y++) {
                    const idx = y * width + x;
                    if (idx < real.length && y < fftCol.real.length) {
                        real[idx] = fftCol.real[y];
                        imag[idx] = fftCol.imag[y];
                    }
                }
            }
            
            return { real, imag };
        }
        
        function ifft2d(fftData, width, height) {
            const real = new Float32Array(fftData.real);
            const imag = new Float32Array(fftData.imag);
            
            // IFFT on rows
            for (let y = 0; y < height; y++) {
                const rowReal = new Float32Array(width);
                const rowImag = new Float32Array(width);
                
                for (let x = 0; x < width; x++) {
                    const idx = y * width + x;
                    if (idx < real.length) {
                        rowReal[x] = real[idx];
                        rowImag[x] = imag[idx];
                    }
                }
                
                const ifftRow = ifft(rowReal, rowImag);
                
                for (let x = 0; x < width; x++) {
                    const idx = y * width + x;
                    if (idx < real.length && x < ifftRow.real.length) {
                        real[idx] = ifftRow.real[x];
                        imag[idx] = ifftRow.imag[x];
                    }
                }
            }
            
            // IFFT on columns
            for (let x = 0; x < width; x++) {
                const colReal = new Float32Array(height);
                const colImag = new Float32Array(height);
                
                for (let y = 0; y < height; y++) {
                    const idx = y * width + x;
                    if (idx < real.length) {
                        colReal[y] = real[idx];
                        colImag[y] = imag[idx];
                    }
                }
                
                const ifftCol = ifft(colReal, colImag);
                
                for (let y = 0; y < height; y++) {
                    const idx = y * width + x;
                    if (idx < real.length && y < ifftCol.real.length) {
                        real[idx] = ifftCol.real[y];
                    }
                }
            }
            
            return real;
        }
        
        // Cooley-Tukey FFT algorithm
        function fft(real, imag) {
            const n = real.length;
            if (n <= 1) return { real, imag };
            
            // Pad to power of 2
            const n2 = Math.pow(2, Math.ceil(Math.log2(n)));
            if (n !== n2) {
                const paddedReal = new Float32Array(n2);
                const paddedImag = new Float32Array(n2);
                paddedReal.set(real);
                paddedImag.set(imag);
                return fft(paddedReal, paddedImag);
            }
            
            // Bit reversal
            const outReal = new Float32Array(n);
            const outImag = new Float32Array(n);
            for (let i = 0; i < n; i++) {
                const rev = bitReverse(i, Math.log2(n));
                outReal[i] = real[rev];
                outImag[i] = imag[rev];
            }
            
            // Cooley-Tukey
            for (let size = 2; size <= n; size *= 2) {
                const halfSize = size / 2;
                const step = 2 * Math.PI / size;
                for (let i = 0; i < n; i += size) {
                    for (let j = 0; j < halfSize; j++) {
                        const angle = step * j;
                        const wReal = Math.cos(angle);
                        const wImag = -Math.sin(angle);
                        
                        const tReal = wReal * outReal[i + j + halfSize] - wImag * outImag[i + j + halfSize];
                        const tImag = wReal * outImag[i + j + halfSize] + wImag * outReal[i + j + halfSize];
                        
                        outReal[i + j + halfSize] = outReal[i + j] - tReal;
                        outImag[i + j + halfSize] = outImag[i + j] - tImag;
                        outReal[i + j] += tReal;
                        outImag[i + j] += tImag;
                    }
                }
            }
            
            return { real: outReal, imag: outImag };
        }
        
        function ifft(real, imag) {
            const n = real.length;
            
            // Conjugate
            const conjImag = new Float32Array(n);
            for (let i = 0; i < n; i++) {
                conjImag[i] = -imag[i];
            }
            
            // Apply FFT
            const result = fft(real, conjImag);
            
            // Conjugate and scale
            for (let i = 0; i < n; i++) {
                result.real[i] /= n;
                result.imag[i] = -result.imag[i] / n;
            }
            
            return result;
        }
        
        function bitReverse(x, bits) {
            let result = 0;
            for (let i = 0; i < bits; i++) {
                result = (result << 1) | (x & 1);
                x >>= 1;
            }
            return result;
        }
        
        function displayResult(data, width, height, canvasId) {
            try {
                // Remove NaN and Infinity values
                for (let i = 0; i < data.length; i++) {
                    if (!isFinite(data[i])) {
                        data[i] = 0;
                    }
                }
                
                // Normalize
                let min = Infinity;
                let max = -Infinity;
                for (let i = 0; i < data.length; i++) {
                    if (data[i] < min) min = data[i];
                    if (data[i] > max) max = data[i];
                }
                
                // Avoid division by zero
                const range = max - min;
                if (range === 0) {
                    min = 0;
                    max = 1;
                }
                
                const canvas = document.getElementById(canvasId);
                canvas.width = width;
                canvas.height = height;
                const ctx = canvas.getContext('2d');
                const imageData = ctx.createImageData(width, height);
                
                for (let i = 0; i < width * height; i++) {
                    const normalized = range === 0 ? 0 : ((data[i] - min) / range) * 255;
                    const value = Math.max(0, Math.min(255, Math.round(normalized)));
                    const idx = i * 4;
                    if (idx + 3 < imageData.data.length) {
                        imageData.data[idx] = value;
                        imageData.data[idx + 1] = value;
                        imageData.data[idx + 2] = value;
                        imageData.data[idx + 3] = 255;
                    }
                }
                
                ctx.putImageData(imageData, 0, 0);
                
                // Store result for later use
                currentResults[canvasId] = canvas.toDataURL();
                
            } catch (error) {
                console.error(`Error displaying ${canvasId}:`, error);
                const canvas = document.getElementById(canvasId);
                canvas.width = 200;
                canvas.height = 50;
                const ctx = canvas.getContext('2d');
                ctx.fillStyle = '#f0f0f0';
                ctx.fillRect(0, 0, 200, 50);
                ctx.fillStyle = '#ff0000';
                ctx.font = '12px Arial';
                ctx.fillText('Error en visualización', 10, 25);
            }
        }
        
        function publishToFeed() {
            if (Object.keys(currentResults).length === 0) {
                alert('Primero procesa una imagen antes de publicar.');
                return;
            }
            
            // Get original image
            const originalCanvas = document.getElementById('originalCanvas');
            const originalImage = originalCanvas.toDataURL();
            
            // Create post object
            const post = {
                id: Date.now(),
                timestamp: new Date(),
                originalImage: originalImage,
                results: { ...currentResults },
                interpretation: generateInterpretation(),
                isExample: false
            };
            
            // Remove example posts when user adds their first real post
            feedPosts = feedPosts.filter(p => !p.isExample);
            
            // Add to feed (newest first)
            feedPosts.unshift(post);
            
            // Save to localStorage
            saveFeedToStorage();
            
            // Render feed
            renderFeed();
            
            // Scroll to feed
            document.getElementById('feedSection').scrollIntoView({ behavior: 'smooth' });
            
            // Show confirmation
            alert('¡Resultado publicado en tu feed! 🎉\n\nTus publicaciones se guardan automáticamente.');
        }
        
        function generateInterpretation() {
            return {
                title: '📊 Análisis de Filtros de Fourier',
                sections: [
                    {
                        title: '🔽 Filtros Pasa-Bajas (Low-Pass)',
                        text: 'Estos filtros eliminan las altas frecuencias (detalles finos y ruido). El resultado es una imagen más suave. El filtro Ideal produce un corte abrupto pero puede generar "ringing". Butterworth ofrece una transición más suave, y Gaussian produce el suavizado más natural tipo "blur".'
                    },
                    {
                        title: '🔼 Filtros Pasa-Altas (High-Pass)',
                        text: 'Estos filtros eliminan las bajas frecuencias (información general) y resaltan los bordes y detalles. Son útiles para detección de contornos. El filtro Ideal es el más agresivo, Butterworth balancea detalle y suavidad, y Gaussian detecta bordes de forma más gradual.'
                    },
                    {
                        title: '💡 Aplicaciones Prácticas',
                        text: 'Los filtros pasa-bajas se usan para reducir ruido en imágenes médicas, suavizar fotos, y preprocesamiento. Los pasa-altas se usan en detección de bordes, realce de texturas, análisis de características, y reconocimiento de patrones.'
                    }
                ]
            };
        }
        
        function renderFeed() {
            const feedContainer = document.getElementById('feedContainer');
            
            if (feedPosts.length === 0) {
                feedContainer.innerHTML = '<div class="no-posts">Aún no has publicado ningún resultado. Procesa una imagen y haz clic en "Publicar Resultado" para crear tu primera publicación.</div>';
                return;
            }
            
            feedContainer.innerHTML = '';
            
            // Add clear button at top
            const clearButton = document.createElement('div');
            clearButton.style.textAlign = 'right';
            clearButton.style.marginBottom = '15px';
            clearButton.innerHTML = `
                <button onclick="clearFeed()" style="background: #e74c3c; color: white; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer; font-size: 13px;">
                    🗑️ Limpiar Feed
                </button>
            `;
            feedContainer.appendChild(clearButton);
            
            feedPosts.forEach((post, index) => {
                const postDiv = document.createElement('div');
                postDiv.className = 'post-item';
                
                const timeAgo = getTimeAgo(post.timestamp);
                const exampleBadge = post.isExample ? '<span style="background: #ffc107; color: #000; padding: 3px 8px; border-radius: 3px; font-size: 11px; font-weight: bold; margin-left: 10px;">EJEMPLO</span>' : '';
                
                postDiv.innerHTML = `
                    <div class="post-header">
                        <div class="post-avatar">👤</div>
                        <div class="post-info">
                            <div class="post-author">Usuario de Visión Computacional ${exampleBadge}</div>
                            <div class="post-time">${timeAgo}</div>
                        </div>
                    </div>
                    
                    <div class="post-content">
                        <p><strong>Procesamiento #${feedPosts.length - index}</strong> - Aplicación de 6 filtros de Fourier</p>
                    </div>
                    
                    <div class="post-images">
                        <div style="text-align: center;">
                            <strong style="font-size: 14px; color: #4267b2; display: block; margin-bottom: 5px;">📷 Original</strong>
                            <img src="${post.originalImage}" style="width: 100%; border-radius: 4px; border: 2px solid #4267b2; margin-top: 5px;">
                        </div>
                    </div>
                    
                    <div style="margin-top: 20px;">
                        <strong style="color: #4267b2; margin-bottom: 10px; display: block; font-size: 15px;">🔽 Filtros Pasa-Bajas (Suavizado):</strong>
                        <div class="post-images">
                            <div style="text-align: center;">
                                <small style="color: #666; font-weight: bold;">Ideal</small>
                                <img src="${post.results.lpIdeal}" style="width: 100%; border-radius: 4px; border: 1px solid #ddd; margin-top: 5px;">
                            </div>
                            <div style="text-align: center;">
                                <small style="color: #666; font-weight: bold;">Butterworth</small>
                                <img src="${post.results.lpButterworth}" style="width: 100%; border-radius: 4px; border: 1px solid #ddd; margin-top: 5px;">
                            </div>
                            <div style="text-align: center;">
                                <small style="color: #666; font-weight: bold;">Gaussian</small>
                                <img src="${post.results.lpGaussian}" style="width: 100%; border-radius: 4px; border: 1px solid #ddd; margin-top: 5px;">
                            </div>
                        </div>
                    </div>
                    
                    <div style="margin-top: 20px;">
                        <strong style="color: #4267b2; margin-bottom: 10px; display: block; font-size: 15px;">🔼 Filtros Pasa-Altas (Realce de Bordes):</strong>
                        <div class="post-images">
                            <div style="text-align: center;">
                                <small style="color: #666; font-weight: bold;">Ideal</small>
                                <img src="${post.results.hpIdeal}" style="width: 100%; border-radius: 4px; border: 1px solid #ddd; margin-top: 5px;">
                            </div>
                            <div style="text-align: center;">
                                <small style="color: #666; font-weight: bold;">Butterworth</small>
                                <img src="${post.results.hpButterworth}" style="width: 100%; border-radius: 4px; border: 1px solid #ddd; margin-top: 5px;">
                            </div>
                            <div style="text-align: center;">
                                <small style="color: #666; font-weight: bold;">Gaussian</small>
                                <img src="${post.results.hpGaussian}" style="width: 100%; border-radius: 4px; border: 1px solid #ddd; margin-top: 5px;">
                            </div>
                        </div>
                    </div>
                    
                    <div class="interpretation-text">
                        <h4>${post.interpretation.title}</h4>
                        ${post.interpretation.sections.map(section => `
                            <p><strong>${section.title}:</strong> ${section.text}</p>
                        `).join('')}
                    </div>
                `;
                
                feedContainer.appendChild(postDiv);
            });
        }
        
        function clearFeed() {
            if (confirm('¿Estás seguro de que quieres eliminar todas las publicaciones del feed?')) {
                feedPosts = [];
                saveFeedToStorage();
                loadExampleData(); // Reload example data
            }
        }
        
        function getTimeAgo(date) {
            const seconds = Math.floor((new Date() - date) / 1000);
            
            if (seconds < 60) return 'Hace unos segundos';
            if (seconds < 3600) return `Hace ${Math.floor(seconds / 60)} minutos`;
            if (seconds < 86400) return `Hace ${Math.floor(seconds / 3600)} horas`;
            return `Hace ${Math.floor(seconds / 86400)} días`;
        }
    </script>
</body>
</html>